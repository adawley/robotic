<!DOCTYPE html>
<html>
    <head>
        <title>worker test</title>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <link rel="stylesheet" type="text/css" href="/robotic/js/worker/worker.css" />
    </head>

    <body>
        <div id="content">
            <p>Count numbers: <output id="worker_count"></output></p>
            <button onclick="workers.add()">Add Worker</button> 
            <button onclick="workers.start();">start</button>
            <button onclick="workers.remove()">Kill Workers</button>
            <button onclick="alert(workers.count());">show count</button>
            <button onclick="workers.names();">show names</button>
            <button onclick="workers.weights();">show weights</button>
            
            <button onclick="workers.stop();">stop</button>

            <br /><br />

            <script>
                
                /*
                 * Array object prototypes
                 */
                Array.prototype.map = function(callback){
                    var i = 0;
                    for(;i<this.length;i++){
                        callback(this[i]);
                    }
                }
                
                /*
                 * Worker object prototypes
                 */                 
                Worker.prototype.init = function(name, weight){
                    // set the message listener
                    this.onmessage = function (event) {
                        var data = event.data;
                        switch (data.cmd) {
                            case 'dead':
                                $('#'+name).remove();
                                break;
                            default:
                                $('#'+name).html(name+': '+event.data);
                                
                        }
                        
                    };
                    this.name(name);
                    this.weight(weight);
                }
                Worker.prototype.kill = function(){
                    this.postMessage({'cmd':'kill'});
                }
                Worker.prototype.name = function(name){
                    name = (typeof(name) === "undefined") ? '' : name;
                    this.postMessage({'cmd':'name','msg': name});
                }
                Worker.prototype.start = function(){
                    this.postMessage({'cmd':'start'});
                }
                Worker.prototype.stop = function(){
                    this.postMessage({'cmd':'stop'});
                }
                Worker.prototype.weight = function(weight){
                    weight = (typeof(weight) === "undefined") ? '' : weight;
                    this.postMessage({'cmd':'weight','msg': weight});
                }
                Worker.prototype.wire = function(worker){
                    this.postMessage({'cmd':'wire','msg':worker});
                }
                
                /*
                 * A wrapper to handle multiple workers
                 */
                function workers(){
                    
                }           
                
                /*
                 * Sets count
                 * returns count
                 */
                workers.count = function(){
                    var l = workers.cata.length;
                    document.getElementById("worker_count").innerHTML = l;
                    return l;
                }
                
                /*
                 * The catalog of workers
                 */
                workers.cata = new Array();
                
                /*
                 * Add a worker
                 * returns the new worker.
                 */
                workers.add = function(){
                    var w=new Worker("worker.js");
                    
                    var name = new Date().getTime();
                    var weight=Math.floor(Math.random()*11)+1;
                    w.init(name, weight);
                   
                    // add it to the stack
                    workers.cata.push(w);
                    
                    // trigger a count update
                    workers.count();
                    
                    $('#content div:last').after("<div class='workerWindow' id='"+name+"'>new div: "+name+"</div>");
                    
                    return w;
                }
                
                /*
                 * Gets the names of the current workers.
                 */
                workers.names = function(){
                    workers.cata.map(function(w){
                        w.name();
                    });
                }
                
                /*
                 * Stops then removes the specified worker. If no worker is 
                 * passed then the last worker is removed.
                 */
                workers.remove = function(worker){
                    // if no worker is passed pop off the last worker
                    if(typeof(worker) === "undefined"){
                        worker = workers.cata.pop();
                    }else {
                        workers.cata.splice(workers.cata.indexOf(worker),1);
                    }
                    
                    worker.kill();
                    workers.count();
                }
                
                /*
                 * Starts the worker.
                 */
                workers.start = function(){
                    workers.cata.map(function(w){
                        w.start(); 
                    });
                }
                
                /*
                 * Stops the worker.
                 */
                workers.stop = function(){
                    workers.cata.map(function(w){
                        w.stop(); 
                    });
                }
                
                /*
                 * Gets the weights of the current workers.
                 */
                workers.weights = function(){
                    workers.cata.map(function(w){
                        w.weight();
                    });
                }



            </script>
            <div id="result"></div>

        </div>
        <button onclick="document.getElementById('result').innerHTML='';">clear buffer</button><br>

    </body>
</html>

